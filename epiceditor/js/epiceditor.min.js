/**
 * EpicEditor - An Embeddable JavaScript Markdown Editor (https://github.com/OscarGodson/EpicEditor)
 * Copyright (c) 2011-2012, Oscar Godson. (MIT Licensed)
 */(function(a,b){function c(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])}function d(a,b){for(var c in b)b.hasOwnProperty(c)&&(a.style[c]=b[c])}function e(b,c){var d=b,e=null;return a.getComputedStyle?e=document.defaultView.getComputedStyle(d,null).getPropertyValue(c):d.currentStyle&&(e=d.currentStyle[c]),e}function g(a){var b=parseInt(e(a,"border-left-width"),10)+parseInt(e(a,"border-right-width"),10),c=parseInt(e(a,"padding-left"),10)+parseInt(e(a,"padding-right"),10),d=a.offsetWidth,f;return isNaN(b)&&(b=0),f=b+c+d,f}function h(a){var b=parseInt(e(a,"border-top-width"),10)+parseInt(e(a,"border-bottom-width"),10),c=parseInt(e(a,"padding-top"),10)+parseInt(e(a,"padding-bottom"),10),d=a.offsetHeight,f;return isNaN(b)&&(b=0),f=b+c+d,f}function i(a,b,d){d=d||"";var e=b.getElementsByTagName("head")[0],f=b.createElement("link");c(f,{type:"text/css",id:d,rel:"stylesheet",href:a+"?"+(new Date).getTime(),name:a,media:"screen"}),e.appendChild(f)}function j(a,b,c){a.className=a.className.replace(b,c)}function k(a){return a.contentDocument||a.contentWindow.document}function l(a){var b;return document.body.innerText?b=a.innerText:b=a.innerHTML.replace(/<br>/gi,"\n"),b}function m(a,b){return document.body.innerText?a.innerText=b:a.innerHTML=b.replace(/\n/g,"<br>"),!0}function n(){var a=-1,b=navigator.userAgent,c=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})");return navigator.appName=="Microsoft Internet Explorer"&&c.exec(b)!=null&&(a=parseFloat(RegExp.$1,10)),a}function o(a){var b={};return a&&b.toString.call(a)==="[object Function]"}function p(){var a=arguments[0]||{},c=1,d=arguments.length,e=!1,f,g,h,i;typeof a=="boolean"&&(e=a,a=arguments[1]||{},c=2),typeof a!="object"&&!o(a)&&(a={}),d===c&&(a=this,--c);for(;c<d;c++)if((f=arguments[c])!=null)for(g in f)if(f.hasOwnProperty(g)){h=a[g],i=f[g];if(a===i)continue;e&&i&&typeof i=="object"&&!i.nodeType?a[g]=p(e,h||(i.length!=null?[]:{}),i):i!==b&&(a[g]=i)}return a}function q(a){var b=a||{},c={container:"epiceditor",basePath:"epiceditor",localStorageName:"epiceditor",file:{name:b.container||"epiceditor",defaultContent:"",autoSave:100},theme:{base:"/themes/base/epiceditor.css",preview:"/themes/preview/github.css",editor:"/themes/editor/epic-dark.css"},focusOnLoad:!1,shortcut:{modifier:18,fullscreen:70,preview:80,edit:79}},d;return this.settings=p(!0,c,b),this.settings.id="epiceditor-"+Math.round(Math.random()*1e5),localStorage&&(localStorage[this.settings.localStorageName]?JSON.parse(localStorage[this.settings.localStorageName]).files[this.settings.file.name]?this.content=this.settings.file.defaultContent:JSON.parse(localStorage[this.settings.localStorageName]).files[this.settings.file.name]=this.settings.file.defaultContent:(d={files:{}},d.files[this.settings.file.name]=this.settings.file.defaultContent,d=JSON.stringify(d),localStorage[this.settings.localStorageName]=d)),this.events||(this.events={}),this.element=document.getElementById(this.settings.container),this}var f=function(a,b,c){var f={},g;if(b==="save"){for(g in c)c.hasOwnProperty(g)&&(f[g]=e(a,g));d(a,c)}else b==="apply"&&d(a,c);return f};q.prototype.load=function(b){function E(a){for(var b=0;b<a.length;b++)a[b].style.width=c.element.offsetWidth-m+"px",a[b].style.height=c.element.offsetHeight-o+"px"}function F(b){if(Math.abs(s.y-b.pageY)>=5||Math.abs(s.x-b.pageX)>=5)q.style.display="block",r&&clearTimeout(r),r=a.setTimeout(function(){q.style.display="none"},1e3);s={y:b.pageY,x:b.pageX}}function G(a){a.keyCode==c.settings.shortcut.modifier&&(z=!0),a.keyCode==17&&(A=!0),z===!0&&a.keyCode==c.settings.shortcut.preview&&!c.eeState.fullscreen&&(a.preventDefault(),c.preview()),z===!0&&a.keyCode==c.settings.shortcut.edit&&(a.preventDefault(),c.eeState.fullscreen||c.edit()),z===!0&&a.keyCode==c.settings.shortcut.fullscreen&&(a.preventDefault(),w(y)),a.keyCode==27&&c.eeState.fullscreen&&(document.body.webkitRequestFullScreen||x(y)),A===!0&&a.keyCode==83&&a.preventDefault()}function H(a){a.keyCode==c.settings.shortcut.modifier&&(z=!1),a.keyCode==17&&(A=!1)}var c=this,j,l,m,o,p,q,r,s={y:-1,x:-1},t,u,v=document.body.webkitRequestFullScreen?!0:!1,w,x,y,z=!1,A=!1,B,C,D;b=b||function(){},c.eeState={fullscreen:!1,preview:!1,edit:!0},j={chrome:'<div class="epiceditor-wrapper epiceditor-edit-mode"><iframe frameborder="0" id="epiceditor-editor-frame"></iframe><iframe frameborder="0" id="epiceditor-previewer-frame"></iframe><div class="epiceditor-utilbar"><img width="16" src="'+this.settings.basePath+'/images/preview.png" class="epiceditor-toggle-btn"> '+'<img width="16" src="'+this.settings.basePath+'/images/fullscreen.png" class="epiceditor-fullscreen-btn">'+"</div>"+"</div>",previewer:'<div class="epiceditor-preview"></div>'},c.element.innerHTML='<iframe scrolling="no" frameborder="0" id= "'+c.settings.id+'"></iframe>',l=document.getElementById(c.settings.id),c.iframeElement=l,c.iframe=k(l),c.iframe.open(),c.iframe.write(j.chrome),c.editorIframe=c.iframe.getElementById("epiceditor-editor-frame"),c.previewerIframe=c.iframe.getElementById("epiceditor-previewer-frame"),c.editorIframeDocument=k(c.editorIframe),c.editorIframeDocument.open(),c.editorIframeDocument.write(""),c.editorIframeDocument.close(),c.previewerIframeDocument=k(c.previewerIframe),c.previewerIframeDocument.open(),c.previewerIframeDocument.write(j.previewer),c.previewerIframeDocument.close(),m=g(c.element)-c.element.offsetWidth,o=h(c.element)-c.element.offsetHeight,E([c.iframeElement,c.editorIframe,c.previewerIframe]),i(c.settings.basePath+c.settings.theme.base,c.iframe),i(c.settings.basePath+c.settings.theme.editor,c.editorIframeDocument),i(c.settings.basePath+c.settings.theme.preview,c.previewerIframeDocument),c.iframe.getElementsByClassName("epiceditor-wrapper")[0].style.position="relative",c.editor=c.editorIframeDocument.body,c.previewer=c.previewerIframeDocument.body.getElementsByClassName("epiceditor-preview")[0],c.editor.contentEditable=!0,c.iframe.body.style.height=this.element.offsetHeight+"px",this.previewerIframe.style.display="none",n()>-1&&(this.previewer.style.height=parseInt(e(this.previewer,"height"),10)+2),i(c.settings.basePath+c.settings.theme.preview,c.previewerIframeDocument,"theme"),this.open(c.settings.file.name),this.settings.focusOnLoad&&this.editor.focus(),c.iframe.getElementsByClassName("epiceditor-toggle-btn")[0].addEventListener("click",function(){c.eeState.edit?c.preview():c.edit()}),p=c.iframe.getElementsByClassName("epiceditor-utilbar")[0],t={},u=c.eeState.edit,w=function(b){v&&b.webkitRequestFullScreen(),c.eeState.fullscreen=!0,c.eeState.edit=!0,c.eeState.preview=!0;var d=a.innerWidth,g=a.innerHeight,h=a.outerWidth,i=a.outerHeight;v||(i=a.innerHeight),t.editorIframe=f(c.editorIframe,"save",{width:h/2+"px",height:i+"px","float":"left",cssFloat:"left",styleFloat:"left",display:"block"}),t.previewerIframe=f(c.previewerIframe,"save",{width:h/2+"px",height:i+"px","float":"right",cssFloat:"right",styleFloat:"right",display:"block"}),t.element=f(c.element,"save",{position:"fixed",top:"0",left:"0",width:"100%","z-index":"9999",zIndex:"9999",border:"none",background:e(c.editor,"background-color"),height:g+"px"}),t.iframeElement=f(c.iframeElement,"save",{width:h+"px",height:g+"px"}),p.style.visibility="hidden",v||(document.body.style.overflow="hidden"),c.preview(!0),c.editor.addEventListener("keyup",function(){c.preview(!0)})},x=function(a){f(c.element,"apply",t.element),f(c.iframeElement,"apply",t.iframeElement),f(c.editorIframe,"apply",t.editorIframe),f(c.previewerIframe,"apply",t.previewerIframe),p.style.visibility="visible",v||(document.body.style.overflow="auto"),c.eeState.fullscreen=!1,u?c.eeState.preview=!1:c.eeState.edit=!1},y=c.iframeElement,c.iframe.getElementsByClassName("epiceditor-fullscreen-btn")[0].addEventListener("click",function(){w(y)}),document.body.webkitRequestFullScreen&&y.addEventListener("webkitfullscreenchange",function(){document.webkitIsFullScreen||x(y)},!1),q=c.iframe.getElementsByClassName("epiceditor-utilbar")[0],q.style.display="none",B=[c.previewerIframeDocument,c.editorIframeDocument];for(D=0;D<B.length;D++)B[D].addEventListener("mousemove",function(a){F(a)}),B[D].addEventListener("keyup",function(a){H(a)}),B[D].addEventListener("keydown",function(a){G(a)});return c.settings.file.autoSave&&(C=a.setInterval(function(){c.content=this.value,c.save(c.settings.file.name,this.value)},c.settings.file.autoSave)),a.addEventListener("resize",function(){!c.iframe.webkitRequestFullScreen&&c.eeState.fullscreen&&(d(c.iframeElement,{width:a.outerWidth+"px",height:a.innerHeight+"px"}),d(c.element,{height:a.innerHeight+"px"}),d(c.previewerIframe,{width:a.outerWidth/2+"px",height:a.innerHeight+"px"}),d(c.editorIframe,{width:a.outerWidth/2+"px",height:a.innerHeight+"px"}))}),c.iframe.close(),b.call(this),this.emit("load"),this},q.prototype.unload=function(b){var c=this,d=a.parent.document.getElementById(c.settings.id);return d.parentNode.removeChild(d),b=b||function(){},b.call(this),c.emit("unload"),c},q.prototype.preview=function(a,b){var c=this,d=c.settings.basePath+c.settings.theme.preview;return typeof a=="boolean"?(b=a,a=d):a=a||d,j(c.get("wrapper"),"epiceditor-edit-mode","epiceditor-preview-mode"),c.previewerIframeDocument.getElementById("theme")?c.previewerIframeDocument.getElementById("theme").name!==a&&(c.previewerIframeDocument.getElementById("theme").href=a):i(a,c.previewerIframeDocument,"theme"),c.previewer.innerHTML=c.exportHTML(),b||(c.editorIframe.style.display="none",c.previewerIframe.style.display="block",c.eeState.preview=!0,c.eeState.edit=!1),c.emit("preview"),c},q.prototype.edit=function(){var a=this;return j(a.get("wrapper"),"epiceditor-preview-mode","epiceditor-edit-mode"),a.eeState.preview=!1,a.eeState.edit=!0,a.editorIframe.style.display="block",a.previewerIframe.style.display="none",a.emit("edit"),this},q.prototype.get=function(a){var b={document:this.iframe,body:this.iframe.body,editor:this.editor,previewer:this.previewer,wrapper:this.iframe.getElementsByClassName("epiceditor-wrapper")[0]};return b[a]?b[a]:null},q.prototype.open=function(a){var b=this,c;return a=a||b.settings.file.name,localStorage&&localStorage[b.settings.localStorageName]&&(c=JSON.parse(localStorage[b.settings.localStorageName]).files,c[a]?m(b.editor,c[a]):m(b.editor,b.settings.file.defaultContent),b.settings.file.name=a,this.previewer.innerHTML=this.exportHTML(),this.emit("open")),this},q.prototype.save=function(a,b){var c=this,d;return a=a||c.settings.file.name,b=b||l(this.editor),d=JSON.parse(localStorage[c.settings.localStorageName]),d.files[a]=b,localStorage[c.settings.localStorageName]=JSON.stringify(d),this.emit("save"),this},q.prototype.remove=function(a){var b=this,c;return a=a||b.settings.file.name,c=JSON.parse(localStorage[b.settings.localStorageName]),delete c.files[a],localStorage[b.settings.localStorageName]=JSON.stringify(c),this.emit("remove"),this},q.prototype.importFile=function(a,b){var c=this;return b=b||"",c.open(a).get("editor").value=b,c.save().open(a),this},q.prototype.rename=function(a,b){var c=this,d=JSON.parse(localStorage[c.settings.localStorageName]);return d.files[b]=d.files[a],delete d.files[a],localStorage[c.settings.localStorageName]=JSON.stringify(d),c.open(b),this},q.prototype.exportHTML=function(){return marked(l(this.editor))},q.prototype.on=function(a,b){var c=this;return this.events[a]||(this.events[a]=[]),this.events[a].push(b),c},q.prototype.emit=function(a,b){function d(a){a.call(c.iframe,b)}var c=this;if(!this.events[a])return;return this.events[a].forEach(d),c},q.prototype.removeListener=function(a,b){var c=this;return b?this.events[a]?(this._events[a].splice(this._events[a].indexOf(b),1),c):c:(this.events[a]=[],c)},a.EpicEditor=q})(window);